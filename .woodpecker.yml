name: Deploy Watchtower

when:
  event:
    - push

steps:
  git-pull:
    image: alpine/git
    volumes:
      - /tank:/tank
    commands:
      - cd /tank/docker/compose/watchtower
      - git config --global --add safe.directory /tank/docker/compose/watchtower
      - git pull origin main

  render-env:
    image: bitnami/minideb
    volumes:
      - /tank:/tank
    environment:
      WATCHTOWER_HOSTNAME: raspberrypi
      WATCHTOWER_NOTIFICATIONS: email
      EMAIL_FROM: from_secret
      EMAIL_TO: from_secret
      EMAIL_SERVER: from_secret
      EMAIL_PORT: from_secret
      EMAIL_USER: from_secret
      EMAIL_PASS: from_secret
      commands:
        - apt-get update && apt-get install -y gettext-base
        - cd /tank/docker/compose/watchtower
        - envsubst < env.template > .env
        - chmod 600 .env

  restart-compose:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tank:/tank
    commands:
      - cd /tank/docker/compose/watchtower
      - docker compose down
      - docker compose up -d

